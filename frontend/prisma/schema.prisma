// frontend/prisma/schema.prisma
// LUC (Ledger Usage Calculator) Database Schema
// @version 2.0.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// Core Entities
// ─────────────────────────────────────────────────────────────────────────────

/// User account with authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  role          String    @default("MEMBER")
  status        String    @default("ACTIVE")

  // Workspace membership
  workspaces    WorkspaceMember[]

  // Audit trail
  auditLogs     AuditLog[]
  policyChanges PolicyVersion[] @relation("CreatedBy")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}



/// Workspace (tenant) - primary scope for LUC
model Workspace {
  id            String    @id @default(uuid())
  name          String
  slug          String    @unique

  // LUC account
  lucAccount    LucAccount?

  // Members
  members       WorkspaceMember[]

  // Usage tracking
  usageEvents   UsageEvent[]

  // Policy
  policies      PolicyVersion[]

  // Audit
  auditLogs     AuditLog[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

/// Workspace membership (many-to-many)
model WorkspaceMember {
  id          String    @id @default(uuid())
  userId      String
  workspaceId String
  role        String        @default("MEMBER")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())

  @@unique([userId, workspaceId])
}



// ─────────────────────────────────────────────────────────────────────────────
// LUC Account and Quotas
// ─────────────────────────────────────────────────────────────────────────────

/// LUC account state per workspace
model LucAccount {
  id            String    @id @default(uuid())
  workspaceId   String    @unique
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Plan info
  planId        String    @default("free")
  status        String        @default("ACTIVE")

  // Quotas stored as JSON (flexible for service additions)
  quotas        String    // JSON: Record<ServiceKey, Quota>

  // Overage policy
  overagePolicy String    @default("block")

  // Billing period
  periodStart   DateTime
  periodEnd     DateTime

  // Stripe integration (optional)
  stripeCustomerId    String?
  stripeSubscriptionId String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}



// ─────────────────────────────────────────────────────────────────────────────
// Usage Events (Append-Only)
// ─────────────────────────────────────────────────────────────────────────────

/// Usage event - immutable record of resource consumption
model UsageEvent {
  id            String    @id @default(uuid())
  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Event details
  userId        String?
  serviceKey    String    // Service being metered
  units         Float     // Amount consumed
  cost          Float     // Calculated cost
  eventType     String    @default("USAGE")

  // Tracing
  requestId     String?   // Request correlation ID

  // Metadata (JSON for flexibility)
  metadata      String?   // JSON: { toolId, route, boomerAngOwner, etc. }

  timestamp     DateTime  @default(now())

  @@index([workspaceId, serviceKey, timestamp])
  @@index([workspaceId, timestamp])
}



// ─────────────────────────────────────────────────────────────────────────────
// Policy Management
// ─────────────────────────────────────────────────────────────────────────────

/// Policy versions with draft/effective states
model PolicyVersion {
  id            String    @id @default(uuid())

  // Scope
  scope         String
  scopeId       String?   // workspace/project/env ID (null for platform)
  workspaceId   String?
  workspace     Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Version control
  version       Int       @default(1)
  status        String       @default("DRAFT")

  // Policy content (JSON)
  policy        String    // JSON: The actual policy configuration

  // Audit
  createdById   String
  createdBy     User      @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime  @default(now())
  effectiveAt   DateTime?
  supersededAt  DateTime?

  @@index([scope, scopeId, status])
  @@index([workspaceId, status])
}



// ─────────────────────────────────────────────────────────────────────────────
// Audit Log
// ─────────────────────────────────────────────────────────────────────────────

/// Audit log for security and compliance
model AuditLog {
  id            String    @id @default(uuid())

  // Actor
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  workspaceId   String?
  workspace     Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  // Action
  action        String    // e.g., "policy.update", "quota.adjust"
  resource      String    // Resource type
  resourceId    String?   // Resource ID

  // Change tracking (JSON)
  previousValue String?   // JSON: Previous state
  newValue      String?   // JSON: New state
  reason        String?   // Why the change was made

  // Request context
  ipAddress     String?
  userAgent     String?

  timestamp     DateTime  @default(now())

  @@index([workspaceId, timestamp])
  @@index([userId, timestamp])
  @@index([resource, resourceId])
}

// ─────────────────────────────────────────────────────────────────────────────
// Evidence Storage (for Gates)
// ─────────────────────────────────────────────────────────────────────────────

/// Evidence run record
model EvidenceRun {
  id            String    @id @default(uuid())

  // Gate info
  gateName      String    // e.g., "lint", "test", "security-scan"
  status        String

  // Timing
  startedAt     DateTime
  completedAt   DateTime?
  durationMs    Int?

  // Results
  summary       String?   // Brief summary
  artifactPath  String?   // Path to artifacts

  // Metadata
  gitCommit     String?
  gitBranch     String?
  triggeredBy   String?   // "ci", "manual", etc.

  createdAt     DateTime  @default(now())

  @@index([gateName, createdAt])
}



// ─────────────────────────────────────────────────────────────────────────────
// Presets (for Flip Secrets, etc.)
// ─────────────────────────────────────────────────────────────────────────────

/// Preset calculation template
model Preset {
  id            String    @id @default(uuid())
  slug          String    @unique
  name          String
  version       String
  category      String
  description   String?

  // Preset definition (JSON)
  definition    String    // JSON: { inputFields, outputFields, formulas }

  // Status
  isActive      Boolean   @default(true)
  isBuiltIn     Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

/// Saved preset calculation
model PresetCalculation {
  id            String    @id @default(uuid())
  presetId      String
  workspaceId   String

  // User inputs and results (JSON)
  inputs        String    // JSON: User-provided values
  outputs       String    // JSON: Calculated results

  // Metadata
  name          String?   // User-defined name for this calculation
  notes         String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([workspaceId, presetId])
}

// ─────────────────────────────────────────────────────────────────────────────
// Active Boomer_Angs Tracking
// ─────────────────────────────────────────────────────────────────────────────

/// Active Boomer_Ang session
model ActiveBoomerAng {
  id            String    @id @default(uuid())
  workspaceId   String
  boomerAngId   String    // Agent identifier
  boomerAngName String    // Display name

  // Session info
  startedAt     DateTime  @default(now())
  lastHeartbeat DateTime  @default(now())

  // Task context
  currentTask   String?
  deploymentId  String?

  @@index([workspaceId])
  @@unique([workspaceId, boomerAngId])
}

// ─────────────────────────────────────────────────────────────────────────────
// The Arena — Contest & Gamification Platform
// ─────────────────────────────────────────────────────────────────────────────

/// Arena player profile (extends User for contest participation)
model ArenaPlayer {
  id            String    @id @default(uuid())
  userId        String    @unique
  displayName   String
  avatarUrl     String?
  tier          String    @default("ROOKIE")  // ROOKIE, CONTENDER, VETERAN, ELITE, LEGEND
  xp            Int       @default(0)
  level         Int       @default(1)
  winCount      Int       @default(0)
  totalContests Int       @default(0)
  winRate       Float     @default(0)
  streak        Int       @default(0)
  bestStreak    Int       @default(0)

  // Wallet
  wallet        ArenaWallet?

  // Contest entries
  entries       ArenaEntry[]

  // Leaderboard entries
  leaderboard   ArenaLeaderboard[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tier, xp])
  @@index([winRate])
}

/// Player wallet for contest entry fees and winnings
model ArenaWallet {
  id            String    @id @default(uuid())
  playerId      String    @unique
  player        ArenaPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)
  balance       Float     @default(0)     // Available balance in USD
  totalDeposited Float    @default(0)
  totalWon      Float     @default(0)
  totalSpent    Float     @default(0)

  // Stripe
  stripeCustomerId String?

  transactions  ArenaWalletTx[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

/// Wallet transaction log (append-only)
model ArenaWalletTx {
  id            String    @id @default(uuid())
  walletId      String
  wallet        ArenaWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type          String    // DEPOSIT, ENTRY_FEE, WINNINGS, REFUND, BONUS
  amount        Float
  balanceAfter  Float
  description   String
  referenceId   String?   // contestId or stripe paymentId
  stripePaymentId String?

  createdAt     DateTime  @default(now())

  @@index([walletId, createdAt])
  @@index([type, createdAt])
}

/// A contest (trivia round, pick'em slate, etc.)
model ArenaContest {
  id            String    @id @default(uuid())
  slug          String    @unique
  title         String
  description   String
  type          String    // TRIVIA, PICKEM, PROSPECT_RANK, OVER_UNDER, STREAK
  category      String    // SPORTS, GENERAL, ENTERTAINMENT, SCIENCE, HISTORY, MIXED
  status        String    @default("UPCOMING")  // UPCOMING, LIVE, SCORING, COMPLETED, CANCELLED
  entryFee      Float     @default(0)   // 0 = free contest
  prizePool     Float     @default(0)
  rakePercent   Float     @default(15)  // Platform take percentage
  maxEntries    Int       @default(100)
  minEntries    Int       @default(2)
  currentEntries Int      @default(0)

  // Timing
  startsAt      DateTime
  endsAt        DateTime
  scoredAt      DateTime?

  // Contest data (JSON) — questions, picks, scoring rules
  contestData   String    // JSON: questions/picks/rules

  // Prize structure (JSON)
  prizeStructure String   // JSON: { 1st: 50%, 2nd: 30%, 3rd: 20% }

  // Auto-generated metadata
  generatedBy   String    @default("SYSTEM")
  difficulty    String    @default("MEDIUM")  // EASY, MEDIUM, HARD, EXPERT
  featured      Boolean   @default(false)

  // Relations
  entries       ArenaEntry[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status, startsAt])
  @@index([type, status])
  @@index([featured, status])
  @@index([category, status])
}

/// A player's entry into a contest
model ArenaEntry {
  id            String    @id @default(uuid())
  contestId     String
  contest       ArenaContest @relation(fields: [contestId], references: [id], onDelete: Cascade)
  playerId      String
  player        ArenaPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  // Submission
  answers       String    // JSON: Array of answers/picks
  submittedAt   DateTime?
  isSubmitted   Boolean   @default(false)

  // Scoring
  score         Float?
  rank          Int?
  correctCount  Int?
  totalQuestions Int?
  payout        Float     @default(0)

  // Entry fee paid
  entryFeePaid  Float     @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([contestId, playerId])
  @@index([playerId, createdAt])
  @@index([contestId, score])
}

/// Global leaderboard (weekly/monthly/all-time snapshots)
model ArenaLeaderboard {
  id            String    @id @default(uuid())
  playerId      String
  player        ArenaPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)
  period        String    // WEEKLY, MONTHLY, ALL_TIME, SEASON_1
  periodKey     String    // e.g., "2026-W07", "2026-02", "all"
  rank          Int
  score         Float     @default(0)
  wins          Int       @default(0)
  entries       Int       @default(0)
  earnings      Float     @default(0)
  accuracy      Float     @default(0)

  updatedAt     DateTime  @updatedAt

  @@unique([playerId, period, periodKey])
  @@index([period, periodKey, rank])
  @@index([period, periodKey, score])
}

/// Imported trivia questions from OpenTDB and other sources
model TriviaQuestion {
  id            String    @id @default(uuid())
  source        String    @default("opentdb")   // opentdb, custom, ai_generated
  externalId    String?
  category      String
  difficulty    String    // easy, medium, hard
  type          String    @default("multiple")  // multiple, boolean
  question      String
  correctAnswer String
  incorrectAnswers String  // JSON array
  tags          String?    // JSON array
  timesUsed     Int       @default(0)
  timesCorrect  Int       @default(0)

  createdAt     DateTime  @default(now())

  @@index([category, difficulty])
  @@index([source])
  @@index([timesUsed])
}

/// Sports pick data for pick'em contests
model SportsPick {
  id            String    @id @default(uuid())
  sport         String    // NFL, NBA, CFB, etc.
  eventDate     DateTime
  homeTeam      String
  awayTeam      String
  league        String?
  status        String    @default("UPCOMING")  // UPCOMING, LIVE, FINAL
  homeScore     Int?
  awayScore     Int?
  spread        Float?
  overUnder     Float?
  result        String?   // HOME, AWAY, PUSH
  metadata      String?   // JSON: odds, props, etc.

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([sport, eventDate])
  @@index([status])
}
