generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// User account with authentication
model User {
  id               String            @id @default(uuid())
  email            String            @unique
  name             String?
  passwordHash     String?
  role             String            @default("MEMBER")
  status           String            @default("ACTIVE")
  resetToken       String?           @unique
  resetTokenExpiry DateTime?
  metadata         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  auditLogs        AuditLog[]
  policyChanges    PolicyVersion[]   @relation("CreatedBy")
  workspaces       WorkspaceMember[]
}

/// Workspace (tenant) - primary scope for LUC
model Workspace {
  id          String            @id @default(uuid())
  name        String
  slug        String            @unique
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  auditLogs   AuditLog[]
  lucAccount  LucAccount?
  policies    PolicyVersion[]
  usageEvents UsageEvent[]
  members     WorkspaceMember[]
}

/// Workspace membership (many-to-many)
model WorkspaceMember {
  id          String    @id @default(uuid())
  userId      String
  workspaceId String
  role        String    @default("MEMBER")
  createdAt   DateTime  @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

/// LUC account state per workspace
model LucAccount {
  id                   String    @id @default(uuid())
  workspaceId          String    @unique
  planId               String    @default("free")
  status               String    @default("ACTIVE")
  quotas               String
  overagePolicy        String    @default("block")
  periodStart          DateTime
  periodEnd            DateTime
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  workspace            Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

/// Usage event - immutable record of resource consumption
model UsageEvent {
  id          String    @id @default(uuid())
  workspaceId String
  userId      String?
  serviceKey  String
  units       Float
  cost        Float
  eventType   String    @default("USAGE")
  requestId   String?
  metadata    String?
  timestamp   DateTime  @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, serviceKey, timestamp])
  @@index([workspaceId, timestamp])
}

/// Policy versions with draft/effective states
model PolicyVersion {
  id           String     @id @default(uuid())
  scope        String
  scopeId      String?
  workspaceId  String?
  version      Int        @default(1)
  status       String     @default("DRAFT")
  policy       String
  createdById  String
  createdAt    DateTime   @default(now())
  effectiveAt  DateTime?
  supersededAt DateTime?
  createdBy    User       @relation("CreatedBy", fields: [createdById], references: [id])
  workspace    Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([scope, scopeId, status])
  @@index([workspaceId, status])
}

/// Audit log for security and compliance
model AuditLog {
  id            String     @id @default(uuid())
  userId        String
  workspaceId   String?
  action        String
  resource      String
  resourceId    String?
  previousValue String?
  newValue      String?
  reason        String?
  ipAddress     String?
  userAgent     String?
  timestamp     DateTime   @default(now())
  workspace     Workspace? @relation(fields: [workspaceId], references: [id])
  user          User       @relation(fields: [userId], references: [id])

  @@index([workspaceId, timestamp])
  @@index([userId, timestamp])
  @@index([resource, resourceId])
}

/// Evidence run record
model EvidenceRun {
  id           String    @id @default(uuid())
  gateName     String
  status       String
  startedAt    DateTime
  completedAt  DateTime?
  durationMs   Int?
  summary      String?
  artifactPath String?
  gitCommit    String?
  gitBranch    String?
  triggeredBy  String?
  createdAt    DateTime  @default(now())

  @@index([gateName, createdAt])
}

/// Preset calculation template
model Preset {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  version     String
  category    String
  description String?
  definition  String
  isActive    Boolean  @default(true)
  isBuiltIn   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

/// Saved preset calculation
model PresetCalculation {
  id          String   @id @default(uuid())
  presetId    String
  workspaceId String
  inputs      String
  outputs     String
  name        String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId, presetId])
}

/// Active Boomer_Ang session
model ActiveBoomerAng {
  id            String   @id @default(uuid())
  workspaceId   String
  boomerAngId   String
  boomerAngName String
  startedAt     DateTime @default(now())
  lastHeartbeat DateTime @default(now())
  currentTask   String?
  deploymentId  String?

  @@unique([workspaceId, boomerAngId])
  @@index([workspaceId])
}

/// Arena player profile (extends User for contest participation)
model ArenaPlayer {
  id            String             @id @default(uuid())
  userId        String             @unique
  displayName   String
  avatarUrl     String?
  tier          String             @default("ROOKIE")
  xp            Int                @default(0)
  level         Int                @default(1)
  winCount      Int                @default(0)
  totalContests Int                @default(0)
  winRate       Float              @default(0)
  streak        Int                @default(0)
  bestStreak    Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  entries       ArenaEntry[]
  leaderboard   ArenaLeaderboard[]
  wallet        ArenaWallet?

  @@index([tier, xp])
  @@index([winRate])
}

/// Player wallet for contest entry fees and winnings
model ArenaWallet {
  id               String          @id @default(uuid())
  playerId         String          @unique
  balance          Float           @default(0)
  totalDeposited   Float           @default(0)
  totalWon         Float           @default(0)
  totalSpent       Float           @default(0)
  stripeCustomerId String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  player           ArenaPlayer     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  transactions     ArenaWalletTx[]
}

/// Wallet transaction log (append-only)
model ArenaWalletTx {
  id              String      @id @default(uuid())
  walletId        String
  type            String
  amount          Float
  balanceAfter    Float
  description     String
  referenceId     String?
  stripePaymentId String?
  createdAt       DateTime    @default(now())
  wallet          ArenaWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
  @@index([type, createdAt])
}

/// A contest (trivia round, pick'em slate, etc.)
model ArenaContest {
  id             String       @id @default(uuid())
  slug           String       @unique
  title          String
  description    String
  type           String
  category       String
  status         String       @default("UPCOMING")
  entryFee       Float        @default(0)
  prizePool      Float        @default(0)
  rakePercent    Float        @default(15)
  maxEntries     Int          @default(100)
  minEntries     Int          @default(2)
  currentEntries Int          @default(0)
  startsAt       DateTime
  endsAt         DateTime
  scoredAt       DateTime?
  contestData    String
  prizeStructure String
  generatedBy    String       @default("SYSTEM")
  difficulty     String       @default("MEDIUM")
  featured       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  entries        ArenaEntry[]

  @@index([status, startsAt])
  @@index([type, status])
  @@index([featured, status])
  @@index([category, status])
}

/// A player's entry into a contest
model ArenaEntry {
  id             String       @id @default(uuid())
  contestId      String
  playerId       String
  answers        String
  submittedAt    DateTime?
  isSubmitted    Boolean      @default(false)
  score          Float?
  rank           Int?
  correctCount   Int?
  totalQuestions Int?
  payout         Float        @default(0)
  entryFeePaid   Float        @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  player         ArenaPlayer  @relation(fields: [playerId], references: [id], onDelete: Cascade)
  contest        ArenaContest @relation(fields: [contestId], references: [id], onDelete: Cascade)

  @@unique([contestId, playerId])
  @@index([playerId, createdAt])
  @@index([contestId, score])
}

/// Global leaderboard (weekly/monthly/all-time snapshots)
model ArenaLeaderboard {
  id        String      @id @default(uuid())
  playerId  String
  period    String
  periodKey String
  rank      Int
  score     Float       @default(0)
  wins      Int         @default(0)
  entries   Int         @default(0)
  earnings  Float       @default(0)
  accuracy  Float       @default(0)
  updatedAt DateTime    @updatedAt
  player    ArenaPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, period, periodKey])
  @@index([period, periodKey, rank])
  @@index([period, periodKey, score])
}

/// Imported trivia questions from OpenTDB and other sources
model TriviaQuestion {
  id               String   @id @default(uuid())
  source           String   @default("opentdb")
  externalId       String?
  category         String
  difficulty       String
  type             String   @default("multiple")
  question         String
  correctAnswer    String
  incorrectAnswers String
  tags             String?
  timesUsed        Int      @default(0)
  timesCorrect     Int      @default(0)
  createdAt        DateTime @default(now())
}

/// CFB Conference
model PerformConference {
  id           String        @id @default(uuid())
  name         String        @unique
  abbreviation String        @unique
  tier         String
  commissioner String?
  hqCity       String?
  hqState      String?
  founded      Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  teams        PerformTeam[]
}

/// CFB Team
model PerformTeam {
  id              String                @id @default(uuid())
  schoolName      String
  commonName      String
  abbreviation    String
  mascot          String
  city            String
  state           String
  stadium         String
  stadiumCapacity Int                   @default(0)
  colors          String
  headCoach       String
  headCoachSince  Int                   @default(2024)
  bio             String?
  founded         Int?
  enrollment      Int?
  conferenceId    String
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  coachesHired    CoachingChange[]      @relation("CoachHired")
  coachesLeft     CoachingChange[]      @relation("CoachLeft")
  nilDeals        NilDeal[]             @relation("NilTeam")
  nilPlayerRanks  NilPlayerRanking[]    @relation("NilPlayerRank")
  nilRankings     NilTeamRanking[]      @relation("NilRanking")
  prospects       PerformProspect[]     @relation("CommittedTo")
  conference      PerformConference     @relation(fields: [conferenceId], references: [id])
  seasons         PerformTeamSeason[]
  budgets         SchoolRevenueBudget[] @relation("RevenueBudget")
  transfersIn     TransferPortalEntry[] @relation("TransferTo")
  transfersOut    TransferPortalEntry[] @relation("TransferFrom")

  @@unique([schoolName, state])
  @@index([conferenceId])
}

/// CFB Team Season Record
model PerformTeamSeason {
  id         String      @id @default(uuid())
  teamId     String
  season     Int
  wins       Int         @default(0)
  losses     Int         @default(0)
  confWins   Int         @default(0)
  confLosses Int         @default(0)
  apRank     Int?
  cfpRank    Int?
  bowlGame   String?
  bowlResult String?
  notes      String?
  createdAt  DateTime    @default(now())
  team       PerformTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, season])
  @@index([season])
}

/// Recruiting Prospect
model PerformProspect {
  id               String       @id @default(uuid())
  slug             String       @unique
  firstName        String
  lastName         String
  position         String
  classYear        String
  school           String
  state            String
  pool             String       @default("HIGH_SCHOOL")
  height           String?
  weight           Int?
  gpa              Float?
  paiScore         Int          @default(0)
  tier             String       @default("DEVELOPMENTAL")
  performance      Int          @default(0)
  athleticism      Int          @default(0)
  intangibles      Int          @default(0)
  nationalRank     Int          @default(9999)
  stateRank        Int          @default(9999)
  positionRank     Int          @default(9999)
  trend            String       @default("NEW")
  previousRank     Int?
  nilEstimate      String?
  scoutMemo        String?
  tags             String?
  comparisons      String?
  stats            String?
  bullCase         String?
  bearCase         String?
  mediationVerdict String?
  debateWinner     String?
  highlightsUrl    String?
  imageUrl         String?
  committedTeamId  String?
  commitDate       DateTime?
  stars            Int?
  sourceUrls       String?
  lastEnriched     DateTime?
  enrichedBy       String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  committedTeam    PerformTeam? @relation("CommittedTo", fields: [committedTeamId], references: [id])

  @@index([tier, nationalRank])
  @@index([position, classYear])
  @@index([state, classYear])
  @@index([pool, classYear])
}

/// Per|Form Content (blog posts, podcasts, scouting reports)
model PerformContent {
  id           String   @id @default(uuid())
  slug         String   @unique
  type         String
  title        String
  excerpt      String?
  body         String?
  prospectId   String?
  prospectName String?
  generatedBy  String   @default("SYSTEM")
  readTimeMin  Int      @default(5)
  tags         String?
  imageUrl     String?
  audioUrl     String?
  published    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([type, published])
  @@index([createdAt])
}

/// NFL Draft-eligible prospect
model DraftProspect {
  id               String      @id @default(uuid())
  slug             String      @unique
  firstName        String
  lastName         String
  position         String
  college          String
  conference       String?
  classYear        String
  eligibility      String?
  height           String?
  weight           Int?
  armLength        String?
  handSize         String?
  fortyYard        Float?
  benchPress       Int?
  verticalJump     Float?
  broadJump        Int?
  threeCone        Float?
  shuttle          Float?
  paiScore         Int         @default(0)
  tier             String      @default("DAY_3")
  performance      Int         @default(0)
  athleticism      Int         @default(0)
  intangibles      Int         @default(0)
  overallRank      Int         @default(9999)
  positionRank     Int         @default(9999)
  trend            String      @default("NEW")
  scoutMemo        String?
  tags             String?
  comparisons      String?
  collegeStats     String?
  seniorBowl       Boolean     @default(false)
  combineInvite    Boolean     @default(false)
  bullCase         String?
  bearCase         String?
  mediationVerdict String?
  debateWinner     String?
  projectedRound   Int?
  projectedPick    Int?
  projectedTeam    String?
  cfbdPlayerId     Int?
  sourceUrls       String?
  lastEnriched     DateTime?
  enrichedBy       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  mockDraftPicks   DraftPick[]

  @@index([tier, overallRank])
  @@index([position])
  @@index([college])
}

/// NFL Team draft needs and picks
model NFLTeamNeeds {
  id           String      @id @default(uuid())
  teamName     String      @unique
  abbreviation String      @unique
  city         String
  conference   String
  division     String
  record       String?
  draftOrder   Int?
  needs        String
  capSpace     String?
  keyFAs       String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  picks        DraftPick[]
}

/// A complete mock draft
model MockDraft {
  id          String      @id @default(uuid())
  slug        String      @unique
  title       String
  description String?
  version     Int         @default(1)
  rounds      Int         @default(7)
  totalPicks  Int         @default(259)
  generatedBy String      @default("SYSTEM")
  isPublished Boolean     @default(false)
  isFeatured  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  picks       DraftPick[]

  @@index([isPublished, createdAt])
}

/// Individual pick in a mock draft
model DraftPick {
  id          String        @id @default(uuid())
  mockDraftId String
  prospectId  String
  nflTeamId   String?
  overall     Int
  round       Int
  pickInRound Int
  teamName    String
  isTradeUp   Boolean       @default(false)
  tradeNote   String?
  fitScore    Int?
  rationale   String?
  createdAt   DateTime      @default(now())
  nflTeam     NFLTeamNeeds? @relation(fields: [nflTeamId], references: [id])
  prospect    DraftProspect @relation(fields: [prospectId], references: [id])
  mockDraft   MockDraft     @relation(fields: [mockDraftId], references: [id], onDelete: Cascade)

  @@unique([mockDraftId, overall])
  @@index([prospectId])
  @@index([mockDraftId, round])
}

/// Sports pick data for pick'em contests
model SportsPick {
  id        String   @id @default(uuid())
  sport     String
  eventDate DateTime
  homeTeam  String
  awayTeam  String
  league    String?
  status    String   @default("UPCOMING")
  homeScore Int?
  awayScore Int?
  spread    Float?
  overUnder Float?
  result    String?
  metadata  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sport, eventDate])
  @@index([status])
}

/// Head coaching change (hire, fire, resign, retire)
model CoachingChange {
  id             String       @id @default(uuid())
  coachName      String
  previousRole   String?
  newRole        String?
  previousTeamId String?
  newTeamId      String?
  changeType     String
  season         Int
  effectiveDate  DateTime?
  contractYears  Int?
  contractValue  String?
  buyout         String?
  record         String?
  notes          String?
  source         String?
  verified       Boolean      @default(false)
  verifiedBy     String?
  verifiedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  newTeam        PerformTeam? @relation("CoachHired", fields: [newTeamId], references: [id])
  previousTeam   PerformTeam? @relation("CoachLeft", fields: [previousTeamId], references: [id])

  @@index([season, changeType])
  @@index([coachName])
  @@index([newTeamId])
  @@index([previousTeamId])
}

/// Player in the transfer portal
model TransferPortalEntry {
  id             String       @id @default(uuid())
  playerName     String
  position       String
  eligibility    String?
  previousTeamId String?
  newTeamId      String?
  status         String       @default("IN_PORTAL")
  season         Int
  enteredDate    DateTime?
  committedDate  DateTime?
  stars          Int?
  previousStats  String?
  nilValuation   String?
  paiScore       Int?
  tier           String?
  transferWindow String       @default("SPRING")
  source         String?
  verified       Boolean      @default(false)
  verifiedBy     String?
  verifiedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  newTeam        PerformTeam? @relation("TransferTo", fields: [newTeamId], references: [id])
  previousTeam   PerformTeam? @relation("TransferFrom", fields: [previousTeamId], references: [id])

  @@index([status, season])
  @@index([position])
  @@index([previousTeamId])
  @@index([newTeamId])
  @@index([transferWindow, season])
}

/// NIL deal record
model NilDeal {
  id                String       @id @default(uuid())
  playerName        String
  teamId            String?
  position          String?
  dealType          String
  brandOrCollective String?
  estimatedValue    Float?
  duration          String?
  status            String       @default("ACTIVE")
  announcedDate     DateTime?
  expiresDate       DateTime?
  season            Int
  source            String?
  verified          Boolean      @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?
  notes             String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  team              PerformTeam? @relation("NilTeam", fields: [teamId], references: [id])

  @@index([teamId, season])
  @@index([playerName])
  @@index([dealType])
  @@index([status])
}

/// Aggregated NIL ranking per team
model NilTeamRanking {
  id              String      @id @default(uuid())
  teamId          String
  season          Int
  rank            Int
  totalNilValue   Float       @default(0)
  avgPerPlayer    Float       @default(0)
  topDealValue    Float       @default(0)
  dealCount       Int         @default(0)
  collectiveCount Int         @default(0)
  trend           String      @default("STEADY")
  previousRank    Int?
  notes           String?
  lastCalculated  DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  team            PerformTeam @relation("NilRanking", fields: [teamId], references: [id])

  @@unique([teamId, season])
  @@index([season, rank])
}

/// Individual player NIL valuation ranking
model NilPlayerRanking {
  id              String       @id @default(uuid())
  playerName      String
  teamId          String?
  position        String?
  season          Int
  rank            Int
  estimatedTotal  Float        @default(0)
  dealCount       Int          @default(0)
  socialFollowing Int?
  trend           String       @default("STEADY")
  previousRank    Int?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  team            PerformTeam? @relation("NilPlayerRank", fields: [teamId], references: [id])

  @@unique([playerName, season])
  @@index([season, rank])
  @@index([teamId])
}

/// School annual revenue/budget â€” acts like NFL salary cap
model SchoolRevenueBudget {
  id              String              @id @default(uuid())
  teamId          String
  season          Int
  totalRevenue    Float               @default(0)
  footballRevenue Float               @default(0)
  nilBudget       Float               @default(0)
  nilSpent        Float               @default(0)
  nilRemaining    Float               @default(0)
  coachingSalary  Float               @default(0)
  operatingBudget Float               @default(0)
  scholarships    Int                 @default(85)
  walkOns         Int                 @default(0)
  rosterSize      Int                 @default(0)
  capSpace        Float               @default(0)
  capRank         Int?
  spendingTier    String              @default("MID")
  tvRevenue       Float               @default(0)
  ticketRevenue   Float               @default(0)
  donorRevenue    Float               @default(0)
  merchandiseRev  Float               @default(0)
  conferenceShare Float               @default(0)
  notes           String?
  lastUpdated     DateTime            @default(now())
  updatedBy       String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  transactions    BudgetTransaction[]
  team            PerformTeam         @relation("RevenueBudget", fields: [teamId], references: [id])

  @@unique([teamId, season])
  @@index([season, capRank])
  @@index([spendingTier])
}

/// Transaction log for school budget changes (like NFL transactions)
model BudgetTransaction {
  id              String              @id @default(uuid())
  budgetId        String
  transactionType String
  description     String
  amount          Float
  playerName      String?
  category        String?
  effectiveDate   DateTime            @default(now())
  createdAt       DateTime            @default(now())
  budget          SchoolRevenueBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId, createdAt])
  @@index([transactionType])
}

/// Agent automation run record
model PerformAutomationRun {
  id             String    @id @default(uuid())
  agentName      String
  taskType       String
  status         String    @default("RUNNING")
  targetModule   String
  recordsScanned Int       @default(0)
  recordsUpdated Int       @default(0)
  recordsCreated Int       @default(0)
  errorCount     Int       @default(0)
  summary        String?
  errors         String?
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  durationMs     Int?
  triggeredBy    String    @default("SCHEDULE")
  createdAt      DateTime  @default(now())

  @@index([agentName, createdAt])
  @@index([taskType, status])
  @@index([targetModule])
}
